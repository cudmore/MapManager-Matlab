
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>mmExamples</title><meta name="generator" content="MATLAB 9.3"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2017-10-11"><meta name="DC.source" content="mmExamples.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#2">Set default plot look and feel</a></li><li><a href="#3">Load a map</a></li><li><a href="#4">Using the default plot structure</a></li><li><a href="#5">Example 1, plotting one stat versus session number</a></li><li><a href="#6">Example 1.1, plotting one stat versus days</a></li><li><a href="#7">Example 1.2, one stat versus days as percent change of session 3</a></li><li><a href="#8">Example 1.3, get the mean/sd/se/n for each session</a></li><li><a href="#9">Example 2, pulling and plotting 2 stats from 2 different channels</a></li><li><a href="#10">Example 2.1, overlay map segment 2 in red</a></li><li><a href="#11">Example 2.3, plot a single stat for two different sessions</a></li><li><a href="#12">Example 3, plot added (green) and subtracted (red) and transient (blue)</a></li><li><a href="#13">Example 4, load a number of maps and pool a stat</a></li><li><a href="#14">Example 5, Generate segment statistics for a given stat</a></li><li><a href="#15">Example 5.1, calculate autocorrelation for each segment for a single stat</a></li><li><a href="#16">Example 6, Plot tracing</a></li><li><a href="#17">Example 7, Display maximal intensity projection with annotations and tracing</a></li><li><a href="#18">Example 8, Plot a stat versus session using session condition</a></li><li><a href="#19">Example 9, Find notes in a map</a></li><li><a href="#20">Example 10, Add new analysis to a map</a></li></ul></div><pre class="codeinput"><span class="comment">% Robert Cudmore</span>
<span class="comment">% 20170927</span>

<span class="comment">% todo:</span>
<span class="comment">%   (1) [done] load multiple maps</span>
<span class="comment">%   (2) [done] plot map based on session condition</span>
<span class="comment">%   (3) pool multiple maps using session condition</span>
<span class="comment">%   (4) nearest-neighbor</span>
<span class="comment">%   (5) segment auto-correlation</span>
<span class="comment">%   (6) Append to map stats</span>
<span class="comment">%</span>
<span class="comment">% todo: [done] write example to get stat and pDist, sort stat by pDist to get</span>
<span class="comment">%    spines in segment order</span>
<span class="comment">% todo: example to plot session condition across maps</span>
<span class="comment">% todo: make GetMapValues return session vector if ps.session ~= nan</span>
<span class="comment">% todo: make GetMapValues fill in ps.val (not ps.y) and</span>
<span class="comment">%   ps.sessionIdx (not ps.x)</span>

cd(<span class="string">'/Users/cudmore/Dropbox/matlab'</span>);
</pre><h2 id="2">Set default plot look and feel</h2><pre class="codeinput">set(0,<span class="string">'DefaultLineMarkerSize'</span>,7);
set(0,<span class="string">'defaultAxesFontSize'</span>,16);
</pre><h2 id="3">Load a map</h2><pre class="codeinput">mapPath = <span class="string">'d:/Users/cudmore/MapManagerData/Richard/rr30a'</span>; <span class="comment">% Windows</span>
mapPath = <span class="string">'/Users/cudmore/Dropbox/MapManagerData/richard/rr30a'</span>; <span class="comment">% Mac OS</span>
obj = mmMap(mapPath);
</pre><pre class="codeoutput">
ans =

    'Loaded map rr30a in 2.320001 seconds'

</pre><h2 id="4">Using the default plot structure</h2><p>Throughout these exmaples we will use a structure to define plotting parameters. Get the default plot structure using mmMap.defaultPlotStruct(). see: help mmMap.defaultPlotStruct</p><pre class="codeinput">ps = mmMap.defaultPlotStruct();
</pre><h2 id="5">Example 1, plotting one stat versus session number</h2><p>see: mmPlot.mapPlot0()</p><pre class="codeinput">ps = mmMap.defaultPlotStruct();
ps.stat = <span class="string">'pDist'</span>; <span class="comment">%'ubssSum';</span>
ps.mapsegment = 0; <span class="comment">% set to NaN for all</span>
ps = obj.GetMapValues(ps);
<span class="comment">% plot with circles and lines</span>
plot(ps.x,ps.y,<span class="string">'ok'</span>, ps.x',ps.y',<span class="string">'-k'</span>);
xlabel(<span class="string">'Session'</span>);
ylabel(<span class="string">'pDist (\mum)'</span>);
</pre><img vspace="5" hspace="5" src="mmExamples_01.png" alt=""> <h2 id="6">Example 1.1, plotting one stat versus days</h2><p>see: mmPlot.mapPlot()</p><pre class="codeinput">ps = mmMap.defaultPlotStruct();
ps.stat = <span class="string">'ubssSum'</span>; <span class="comment">%'ubssSum';</span>
ps.channel = 2;
ps.mapsegment = 0; <span class="comment">% set to NaN for all</span>
ps = obj.GetMapValues(ps);
plot(ps.days,ps.y,<span class="string">'ok'</span>, ps.days',ps.y',<span class="string">'-k'</span>);
xlabel(<span class="string">'Days'</span>);
ylabel([ps.stat <span class="string">' ch'</span> num2str(ps.channel)]);
</pre><img vspace="5" hspace="5" src="mmExamples_02.png" alt=""> <h2 id="7">Example 1.2, one stat versus days as percent change of session 3</h2><p>see: mmPlot.mapPlotNorm()</p><pre class="codeinput">ps = mmMap.defaultPlotStruct();
ps.stat = <span class="string">'ubssSum'</span>; <span class="comment">%'ubssSum';</span>
ps.channel = 2;
ps.mapsegment = nan; <span class="comment">% set to NaN for all</span>
ps = obj.GetMapValues(ps);
normSession = 3;
percentChange = bsxfun(@rdivide, ps.y, ps.y(:,normSession)) * 100;
plot(ps.days, percentChange, <span class="string">'ok'</span>, ps.days',percentChange',<span class="string">'-k'</span>);
xlabel(<span class="string">'Days'</span>);
ylabel([<span class="string">'% Change '</span> ps.stat <span class="string">' ch'</span> num2str(ps.channel)]);
</pre><img vspace="5" hspace="5" src="mmExamples_03.png" alt=""> <h2 id="8">Example 1.3, get the mean/sd/se/n for each session</h2><p>THIS IS NOT WORKING notNan = ~isnan(percentChange); % get non nan 'logical array' once and reuse theMean = mean(notNan,1); thestd = std(notNan,1); theCount = sum(notNan,1); these = thestd ./ sqrt(theCount-1); theDays = mean(~isnan(ps.days)); plot(ps.days, percentChange, 'ok', ps.days',percentChange','-k'); hold on errorbar(ps.days,theMean, these)</p><h2 id="9">Example 2, pulling and plotting 2 stats from 2 different channels</h2><pre class="codeinput">ps1 = mmMap.defaultPlotStruct();
ps1.mapsegmentid = NaN; <span class="comment">% set to NaN for all</span>

ps1.stat = <span class="string">'ubssSum'</span>; <span class="comment">% background subtracted spine sum</span>
ps1.channel = 2;
ps1 = obj.GetMapValues(ps1);

ps2 = ps1; <span class="comment">% make sure they match (e.g. mapsegmentid)</span>
ps2.stat = <span class="string">'ubsdSum'</span>; <span class="comment">% background subtracted dendrite sum</span>
ps2.channel = 1;
ps2 = obj.GetMapValues(ps2);

plot(ps1.y, ps2.y,<span class="string">'ok'</span>);
xlabel([ps1.stat <span class="string">' ch'</span> num2str(ps1.channel)]);
ylabel([ps2.stat <span class="string">' ch'</span> num2str(ps2.channel)]);
</pre><img vspace="5" hspace="5" src="mmExamples_04.png" alt=""> <h2 id="10">Example 2.1, overlay map segment 2 in red</h2><p>This is useful to see the distribution of one segment in the context   of all other segments</p><pre class="codeinput">ps1.mapsegment = 2;
ps1 = obj.GetMapValues(ps1);
ps2.mapsegment = 2;
ps2 = obj.GetMapValues(ps2);
hold <span class="string">on</span>;
plot(ps1.y, ps2.y, <span class="string">'or'</span>, <span class="string">'MarkerFaceColor'</span>, <span class="string">'r'</span>);
hold <span class="string">off</span>;
</pre><img vspace="5" hspace="5" src="mmExamples_05.png" alt=""> <h2 id="11">Example 2.3, plot a single stat for two different sessions</h2><p>see: mmPlot.mapPlotSession() This is useful to see how stats evolve over time   and can be used to examine percent or absolute change</p><pre class="codeinput">ps = mmMap.defaultPlotStruct();
ps.stat = <span class="string">'ubssSum'</span>;
ps.channel = 2;
ps = obj.GetMapValues(ps); <span class="comment">% ps.y has ps.stat for all sessions</span>
xSession = 2;
ySession = 5;
plot(ps.y(:,xSession), ps.y(:,ySession), <span class="string">'ok'</span>);
xlabel([ps.stat <span class="string">' session '</span> num2str(xSession)]);
ylabel([ps.stat <span class="string">' session '</span> num2str(ySession)]);

<span class="comment">%Homework: Fit a line to this session plot to see if the stat changes with time.</span>
</pre><img vspace="5" hspace="5" src="mmExamples_06.png" alt=""> <h2 id="12">Example 3, plot added (green) and subtracted (red) and transient (blue)</h2><pre class="codeinput"><span class="comment">%todo: rewrite to return all dynamics in plot struct</span>
ds = mmMap.defaultPlotStruct();
ds = obj.GetMapDynamics(ds);

ps = mmMap.defaultPlotStruct();
ps.stat = <span class="string">'pDist'</span>; <span class="comment">%'ubssSum';</span>
ps.mapsegment = 0; <span class="comment">% set to NaN for all</span>
ps = obj.GetMapValues(ps);

[m,n] = size(ps.y); <span class="comment">% GetMapValues() and GetMapDynamics() return the same size</span>
yAdd = nan(m,n);
yAdd(ds.added==1) = ps.y(ds.added==1);
ySub = nan(m,n);
ySub(ds.subtracted==1) = ps.y(ds.subtracted==1);
yTransient = nan(m,n);
yTransient(ds.transient==1) = ps.y(ds.transient==1);

plot(ps.x, ps.y, <span class="string">'ok'</span>, <span class="string">'MarkerFaceColor'</span>, <span class="string">'k'</span>, <span class="string">'MarkerEdgeColor'</span>, <span class="string">'k'</span>);
hold <span class="string">on</span>;
plot(ps.x', ps.y', <span class="string">'-k'</span>);
hold <span class="string">on</span>;
plot(ps.x, yAdd, <span class="string">'og'</span>, <span class="string">'MarkerFaceColor'</span>, <span class="string">'g'</span>, <span class="string">'MarkerEdgeColor'</span>, <span class="string">'g'</span>);
plot(ps.x,ySub,<span class="string">'or'</span>, <span class="string">'MarkerFaceColor'</span>, <span class="string">'r'</span>, <span class="string">'MarkerEdgeColor'</span>, <span class="string">'r'</span>);
plot(ps.x,yTransient,<span class="string">'ob'</span>, <span class="string">'MarkerFaceColor'</span>, <span class="string">'b'</span>, <span class="string">'MarkerEdgeColor'</span>, <span class="string">'b'</span>);
hold <span class="string">off</span>;
</pre><img vspace="5" hspace="5" src="mmExamples_07.png" alt=""> <h2 id="13">Example 4, load a number of maps and pool a stat</h2><p>todo: finish pooling across session conditions (condStr) in poolMaps.m</p><pre class="codeinput">myMapList = {};
numLoadedMaps = 1;
folderPath = <span class="string">'/Users/cudmore/Dropbox/MapManagerData/richard'</span>;
files = dir(folderPath);
subFolders = files([files.isdir]);
<span class="keyword">for</span> i = 1:length(subFolders)
    folderName = subFolders(i).name;
    <span class="keyword">if</span> strcmp(folderName,<span class="string">'.'</span>) || strcmp(folderName,<span class="string">'..'</span>)
        <span class="keyword">continue</span>
    <span class="keyword">end</span>
    mapPath = [folderPath <span class="string">'/'</span> folderName];
    myMapList{numLoadedMaps} = mmMap(mapPath);
    numLoadedMaps = numLoadedMaps + 1;
<span class="keyword">end</span>
</pre><pre class="codeoutput">
ans =

    'Loaded map rr30a in 2.447364 seconds'


ans =

    'Loaded map rr49c in 1.455828 seconds'


ans =

    'Loaded map rr50b in 2.370052 seconds'


ans =

    'Loaded map rr52c in 2.862264 seconds'


ans =

    'Loaded map rr58b in 3.861079 seconds'


ans =

    'Loaded map rr58c in 2.303042 seconds'

</pre><h2 id="14">Example 5, Generate segment statistics for a given stat</h2><p>See segmentStats.m for a template function to write your own analysis code todo: make this a member function of mmMap</p><pre class="codeinput">channel = 2;
fnReference = @segmentStats;
mySegmentStats = segmentanalysis(obj, <span class="string">'ubssSum'</span>, channel, fnReference);
mySegmentStats
</pre><pre class="codeoutput">
mySegmentStats = 

  5&times;9 struct array with fields:

    mean
    std
    count
    se

</pre><h2 id="15">Example 5.1, calculate autocorrelation for each segment for a single stat</h2><p>This is simple, we make a new matlab function (in a .m file) following   the prototype of segmentStats() in segmentStats.m. In this function we (1) sort val along pDist and (2) use autocorr   function (Requires xxx toolbox)</p><h2 id="16">Example 6, Plot tracing</h2><p>see: mmPlot.mapPlotTracing()</p><pre class="codeinput"><span class="comment">% look at first 5 rows in linedb table</span>
obj.linedb{1}(1:5,:)

ps = mmMap.defaultPlotStruct();
ps.mapsegment = NaN; <span class="comment">%0</span>
ps.session = 1;
ps = obj.GetLine(ps);

plot(ps.line(:,1), ps.line(:,2), <span class="string">'.k'</span>, <span class="string">'MarkerSize'</span>, 25);
xlabel(<span class="string">'\mum'</span>);
ylabel(<span class="string">'\mum'</span>);
</pre><pre class="codeoutput">
ans =

  5&times;22 table

    node    type      x       y      z     zFloor    radius    radiusFit    prevNode    ID    gID    tx     ty     tz     sDist     pDist     Filament    SetID    GroupID    sDist3d    pDist3d    Var22
    ____    ____    _____    ____    __    ______    ______    _________    ________    __    ___    ___    ___    ___    _____    _______    ________    _____    _______    _______    _______    _____

    NaN     NaN     42.48    28.8    31    31        NaN       NaN          -1          0     NaN    NaN    NaN    NaN       0     -41.398    NaN         NaN      NaN           0       -42.243    ''   
    NaN     NaN      42.6    28.8    31    31        NaN       NaN           0          0     NaN    NaN    NaN    NaN    0.12     -41.278    NaN         NaN      NaN        0.12       -42.123    ''   
    NaN     NaN     42.72    28.8    31    31        NaN       NaN           1          0     NaN    NaN    NaN    NaN    0.24     -41.158    NaN         NaN      NaN        0.24       -42.003    ''   
    NaN     NaN     42.84    28.8    31    31        NaN       NaN           2          0     NaN    NaN    NaN    NaN    0.36     -41.038    NaN         NaN      NaN        0.36       -41.883    ''   
    NaN     NaN     42.96    28.8    31    31        NaN       NaN           3          0     NaN    NaN    NaN    NaN    0.48     -40.918    NaN         NaN      NaN        0.48       -41.763    ''   

</pre><img vspace="5" hspace="5" src="mmExamples_08.png" alt=""> <h2 id="17">Example 7, Display maximal intensity projection with annotations and tracing</h2><p>see: mmPlot.mapPlotImage()</p><pre class="codeinput">ps = mmMap.defaultPlotStruct();
ps.session = 1;
ps.channel = 2;showAnnotations = 1;
showLines = 1;
plotMaxProject(obj,ps,showAnnotations, showLines);
</pre><img vspace="5" hspace="5" src="mmExamples_09.png" alt=""> <h2 id="18">Example 8, Plot a stat versus session using session condition</h2><p>see: mmPlot.mapPlotCondition()</p><pre class="codeinput"><span class="comment">%Each session in a map has a session condition</span>
<span class="comment">%obj.mapNV('condStr',:)</span>
<span class="comment">%mp = mmPlot(obj);</span>
<span class="comment">%h = mp.mapPlotCondition('ubssSum', 2, {'a1', 'b1', 'c2'});</span>

<span class="comment">% You can easily set session conditions yourself</span>
<span class="comment">%obj.mapNV('cond',[1 2 3 4]) = ['c1', 'c2','e1','e2']</span>
</pre><h2 id="19">Example 9, Find notes in a map</h2><pre class="codeinput">result1 = obj.find(<span class="string">'note'</span>, <span class="string">'Dim?'</span>);
result1(1:5,:) <span class="comment">% view table of first 5 results</span>
result2 = obj.find(<span class="string">'note'</span>, <span class="string">'*'</span>);
result2(1:5,:) <span class="comment">% view table of first 5 results</span>
</pre><pre class="codeoutput">
ans =

  5&times;52 table

    session    Idx     roiType      roiTypeNum      x         y       z     channel    groupID    parentID    cPnt    sDist      pDist     cAuto    cAngle      cLine      cLineNum      cx        cy       cz       cDate         cTime         mDate         mTime        cSeconds      mSeconds      userName       note     edgeList    isDirty    isBad    dynBad    intBad    progType    madeFrom    analParam    analResult1    analResult2    analResult3    analResult4    user1    user2    user3    userBool1    userBool2    userBool3    userType    bSpineMap    bSpineIdx    error    warning    Var51
    _______    ___    __________    __________    ______    ______    __    _______    _______    ________    ____    ______    _______    _____    ______    _________    ________    ______    ______    ____    __________    __________    __________    __________    __________    __________    ___________    ______    ________    _______    _____    ______    ______    ________    ________    _________    ___________    ___________    ___________    ___________    _____    _____    _____    _________    _________    _________    ________    _________    _________    _____    _______    _____

    1          287    'spineROI'    0             19.033      39.9    32    1          NaN        4           1920    6.0462    -9.8088    0        265.88    'radius1'    1           20.095    39.154      31    2015-10-14    '12:26:18'    2015-12-14    '09:29:34'    3.5277e+09    3.5329e+09    'Nancy Luo'    'Dim?'    NaN         NaN        NaN      NaN       NaN       NaN         1           NaN          NaN            NaN            NaN            NaN            NaN      NaN      NaN      NaN          NaN          NaN          NaN         NaN          NaN          ''       [NaN]      ''   
    3           74    'spineROI'    0             80.472     26.17    33    1          NaN        0            306    38.406      -2.76    0         280.4    'radius1'    1            80.16     24.47      33    2015-10-07    '12:55:24'    2015-12-14    '09:29:36'    3.5271e+09    3.5329e+09    'Nancy Luo'    'Dim?'    NaN         NaN        NaN      NaN       NaN       NaN         1           NaN          NaN            NaN            NaN            NaN            NaN      NaN      NaN      NaN          NaN          NaN          NaN         NaN          NaN          [NaN]    [NaN]      ''   
    3           77    'spineROI'    0             60.672     23.12    32    1          NaN        0            132     17.29    -23.876    0        33.099    'radius2'    2            59.51    24.755    33.4    2015-10-07    '13:02:54'    2015-12-14    '09:29:36'    3.5271e+09    3.5329e+09    'Nancy Luo'    'Dim?'    NaN         NaN        NaN      NaN       NaN       NaN         1           NaN          NaN            NaN            NaN            NaN            NaN      NaN      NaN      NaN          NaN          NaN          NaN         NaN          NaN          [NaN]    [NaN]      ''   
    3           78    'spineROI'    0             56.722     22.07    33    1          NaN        0            122     16.04    -25.126    0        121.72    'radius2'    2            58.44     24.85      33    2015-10-07    '13:04:32'    2015-12-14    '09:29:36'    3.5271e+09    3.5329e+09    'Nancy Luo'    'Dim?'    NaN         NaN        NaN      NaN       NaN       NaN         1           NaN          NaN            NaN            NaN            NaN            NaN      NaN      NaN      NaN          NaN          NaN          NaN         NaN          NaN          [NaN]    [NaN]      ''   
    5          221    'spineROI'    0             31.102    83.143    14    1          NaN        2           1288    22.471    -21.227    0        458.29    'radius2'    2           30.071    83.299      15    2015-10-09    '13:39:55'    2015-12-14    '09:29:38'    3.5272e+09    3.5329e+09    'Nancy Luo'    'Dim?'    NaN         NaN        NaN      NaN       NaN       NaN         1           NaN          NaN            NaN            NaN            NaN            NaN      NaN      NaN      NaN          NaN          NaN          NaN         NaN          NaN          ''       [NaN]      ''   


ans =

  5&times;52 table

    session    Idx     roiType      roiTypeNum      x         y       z     channel    groupID    parentID    cPnt    sDist      pDist     cAuto    cAngle      cLine      cLineNum      cx        cy       cz       cDate         cTime         mDate         mTime        cSeconds      mSeconds      userName             note           edgeList    isDirty    isBad    dynBad    intBad    progType    madeFrom    analParam    analResult1    analResult2    analResult3    analResult4    user1    user2    user3    userBool1    userBool2    userBool3    userType    bSpineMap    bSpineIdx    error    warning    Var51
    _______    ___    __________    __________    ______    ______    __    _______    _______    ________    ____    ______    _______    _____    ______    _________    ________    ______    ______    ____    __________    __________    __________    __________    __________    __________    ___________    __________________    ________    _______    _____    ______    ______    ________    ________    _________    ___________    ___________    ___________    ___________    _____    _____    _____    _________    _________    _________    ________    _________    _________    _____    _______    _____

    1           78    'spineROI'    0             83.545    26.578    29    1          NaN        0            359    43.707     2.3091    0        263.48    'radius1'    1           83.779    25.223      30    2015-10-02    '15:46:10'    2015-12-14    '09:29:34'    3.5266e+09    3.5329e+09    'Nancy Luo'    'Spine?'              NaN         NaN          0      NaN       NaN       NaN         0           NaN          NaN            NaN            NaN            NaN            NaN      NaN      NaN      NaN          NaN          NaN          NaN         NaN          NaN          ''       [NaN]      ''   
    1          217    'spineROI'    0             42.316    106.98    18    1          NaN        2           1527    51.967     6.5262    0        439.09    'radius2'    2            41.34    107.07      19    2015-10-09    '12:25:10'    2015-12-14    '09:29:34'    3.5272e+09    3.5329e+09    'Nancy Luo'    'Is this a spine?'    NaN         NaN        NaN      NaN       NaN       NaN         1           NaN          NaN            NaN            NaN            NaN            NaN      NaN      NaN      NaN          NaN          NaN          NaN         NaN          NaN          ''       [NaN]      ''   
    1          287    'spineROI'    0             19.033      39.9    32    1          NaN        4           1920    6.0462    -9.8088    0        265.88    'radius1'    1           20.095    39.154      31    2015-10-14    '12:26:18'    2015-12-14    '09:29:34'    3.5277e+09    3.5329e+09    'Nancy Luo'    'Dim?'                NaN         NaN        NaN      NaN       NaN       NaN         1           NaN          NaN            NaN            NaN            NaN            NaN      NaN      NaN      NaN          NaN          NaN          NaN         NaN          NaN          ''       [NaN]      ''   
    2          213    'spineROI'    0              28.72    83.673    17    1          NaN        2            850    21.291    -22.175    0        257.29    'radius1'    1           30.901    82.771    16.4    2015-10-09    '13:15:59'    2015-12-14    '09:29:35'    3.5272e+09    3.5329e+09    'Nancy Luo'    'Dimp'                NaN         NaN        NaN      NaN       NaN       NaN         1           NaN          NaN            NaN            NaN            NaN            NaN      NaN      NaN      NaN          NaN          NaN          NaN         NaN          NaN          [NaN]    [NaN]      ''   
    3           70    'spineROI'    0             93.996    26.816    34    1          NaN        0            423    52.633     11.467    0        278.65    'radius1'    1            93.84     25.79      33    2015-10-02    '17:12:21'    2015-12-14    '09:29:36'    3.5267e+09    3.5329e+09    'Nancy Luo'    'dim'                 NaN         NaN        NaN      NaN       NaN       NaN         1           NaN          NaN            NaN            NaN            NaN            NaN      NaN      NaN      NaN          NaN          NaN          NaN         NaN          NaN          [NaN]    [NaN]      ''   

</pre><h2 id="20">Example 10, Add new analysis to a map</h2><pre class="codeinput">ps = mmMap.defaultPlotStruct();
ps.stat = <span class="string">'ubssSum'</span>; <span class="comment">%'ubssSum';</span>
ps.channel  = 2;
ps = obj.GetMapValues(ps);
newStatName = <span class="string">'myNewStat'</span>;
[m,n] = size(ps.y);
newStatValues = NaN(m,n);
newStatValues = ps.y .* mean(ps.y(~isnan(ps.y))); <span class="comment">% ubssSum / mean(ubssSum);</span>
obj = obj.addUserStat(newStatName, newStatValues);

<span class="comment">% and then plot the new stat</span>
myMapPlot = mmPlot(obj);
myMapPlot.mapPlot(NaN, newStatName, NaN);
</pre><img vspace="5" hspace="5" src="mmExamples_10.png" alt=""> <p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2017b</a><br></p></div><!--
##### SOURCE BEGIN #####
% Robert Cudmore
% 20170927

% todo:
%   (1) [done] load multiple maps
%   (2) [done] plot map based on session condition
%   (3) pool multiple maps using session condition
%   (4) nearest-neighbor
%   (5) segment auto-correlation
%   (6) Append to map stats
%
% todo: [done] write example to get stat and pDist, sort stat by pDist to get
%    spines in segment order
% todo: example to plot session condition across maps
% todo: make GetMapValues return session vector if ps.session ~= nan
% todo: make GetMapValues fill in ps.val (not ps.y) and
%   ps.sessionIdx (not ps.x)

cd('/Users/cudmore/Dropbox/matlab');

%% Set default plot look and feel
set(0,'DefaultLineMarkerSize',7);
set(0,'defaultAxesFontSize',16);


%% Load a map
mapPath = 'd:/Users/cudmore/MapManagerData/Richard/rr30a'; % Windows
mapPath = '/Users/cudmore/Dropbox/MapManagerData/richard/rr30a'; % Mac OS
obj = mmMap(mapPath);

%% Using the default plot structure
% Throughout these exmaples we will use a structure to define plotting
% parameters. Get the default plot structure using mmMap.defaultPlotStruct().
% see: help mmMap.defaultPlotStruct

ps = mmMap.defaultPlotStruct();


%% Example 1, plotting one stat versus session number
% see: mmPlot.mapPlot0()
ps = mmMap.defaultPlotStruct();
ps.stat = 'pDist'; %'ubssSum';
ps.mapsegment = 0; % set to NaN for all
ps = obj.GetMapValues(ps);
% plot with circles and lines
plot(ps.x,ps.y,'ok', ps.x',ps.y','-k');
xlabel('Session');
ylabel('pDist (\mum)');

%% Example 1.1, plotting one stat versus days
% see: mmPlot.mapPlot()
ps = mmMap.defaultPlotStruct();
ps.stat = 'ubssSum'; %'ubssSum';
ps.channel = 2;
ps.mapsegment = 0; % set to NaN for all
ps = obj.GetMapValues(ps);
plot(ps.days,ps.y,'ok', ps.days',ps.y','-k');
xlabel('Days');
ylabel([ps.stat ' ch' num2str(ps.channel)]);


%% Example 1.2, one stat versus days as percent change of session 3
% see: mmPlot.mapPlotNorm()
ps = mmMap.defaultPlotStruct();
ps.stat = 'ubssSum'; %'ubssSum';
ps.channel = 2;
ps.mapsegment = nan; % set to NaN for all
ps = obj.GetMapValues(ps);
normSession = 3;
percentChange = bsxfun(@rdivide, ps.y, ps.y(:,normSession)) * 100;
plot(ps.days, percentChange, 'ok', ps.days',percentChange','-k');
xlabel('Days');
ylabel(['% Change ' ps.stat ' ch' num2str(ps.channel)]);


%% Example 1.3, get the mean/sd/se/n for each session
% THIS IS NOT WORKING
% notNan = ~isnan(percentChange); % get non nan 'logical array' once and reuse
% theMean = mean(notNan,1);
% thestd = std(notNan,1);
% theCount = sum(notNan,1);
% these = thestd ./ sqrt(theCount-1);
% theDays = mean(~isnan(ps.days));
% plot(ps.days, percentChange, 'ok', ps.days',percentChange','-k');
% hold on
% errorbar(ps.days,theMean, these)


%% Example 2, pulling and plotting 2 stats from 2 different channels
ps1 = mmMap.defaultPlotStruct();
ps1.mapsegmentid = NaN; % set to NaN for all

ps1.stat = 'ubssSum'; % background subtracted spine sum
ps1.channel = 2;
ps1 = obj.GetMapValues(ps1);

ps2 = ps1; % make sure they match (e.g. mapsegmentid)
ps2.stat = 'ubsdSum'; % background subtracted dendrite sum
ps2.channel = 1;
ps2 = obj.GetMapValues(ps2);

plot(ps1.y, ps2.y,'ok');
xlabel([ps1.stat ' ch' num2str(ps1.channel)]);
ylabel([ps2.stat ' ch' num2str(ps2.channel)]);


%% Example 2.1, overlay map segment 2 in red
% This is useful to see the distribution of one segment in the context
%   of all other segments
ps1.mapsegment = 2;
ps1 = obj.GetMapValues(ps1);
ps2.mapsegment = 2;
ps2 = obj.GetMapValues(ps2);
hold on;
plot(ps1.y, ps2.y, 'or', 'MarkerFaceColor', 'r');
hold off;

%% Example 2.3, plot a single stat for two different sessions
% see: mmPlot.mapPlotSession()
% This is useful to see how stats evolve over time
%   and can be used to examine percent or absolute change
ps = mmMap.defaultPlotStruct();
ps.stat = 'ubssSum';
ps.channel = 2;
ps = obj.GetMapValues(ps); % ps.y has ps.stat for all sessions
xSession = 2;
ySession = 5;
plot(ps.y(:,xSession), ps.y(:,ySession), 'ok');
xlabel([ps.stat ' session ' num2str(xSession)]);
ylabel([ps.stat ' session ' num2str(ySession)]);

%Homework: Fit a line to this session plot to see if the stat changes with time.


%% Example 3, plot added (green) and subtracted (red) and transient (blue)
%todo: rewrite to return all dynamics in plot struct
ds = mmMap.defaultPlotStruct();
ds = obj.GetMapDynamics(ds);

ps = mmMap.defaultPlotStruct();
ps.stat = 'pDist'; %'ubssSum';
ps.mapsegment = 0; % set to NaN for all
ps = obj.GetMapValues(ps);

[m,n] = size(ps.y); % GetMapValues() and GetMapDynamics() return the same size
yAdd = nan(m,n);
yAdd(ds.added==1) = ps.y(ds.added==1);
ySub = nan(m,n);
ySub(ds.subtracted==1) = ps.y(ds.subtracted==1);
yTransient = nan(m,n);
yTransient(ds.transient==1) = ps.y(ds.transient==1);

plot(ps.x, ps.y, 'ok', 'MarkerFaceColor', 'k', 'MarkerEdgeColor', 'k');
hold on;
plot(ps.x', ps.y', '-k');
hold on;
plot(ps.x, yAdd, 'og', 'MarkerFaceColor', 'g', 'MarkerEdgeColor', 'g');
plot(ps.x,ySub,'or', 'MarkerFaceColor', 'r', 'MarkerEdgeColor', 'r');
plot(ps.x,yTransient,'ob', 'MarkerFaceColor', 'b', 'MarkerEdgeColor', 'b');
hold off;


%% Example 4, load a number of maps and pool a stat
% todo: finish pooling across session conditions (condStr) in poolMaps.m
myMapList = {};
numLoadedMaps = 1;
folderPath = '/Users/cudmore/Dropbox/MapManagerData/richard';
files = dir(folderPath);
subFolders = files([files.isdir]);
for i = 1:length(subFolders)
    folderName = subFolders(i).name;
    if strcmp(folderName,'.') || strcmp(folderName,'..')
        continue
    end
    mapPath = [folderPath '/' folderName];
    myMapList{numLoadedMaps} = mmMap(mapPath);
    numLoadedMaps = numLoadedMaps + 1;
end


%% Example 5, Generate segment statistics for a given stat
% See segmentStats.m for a template function to write your own analysis code
% todo: make this a member function of mmMap
channel = 2;
fnReference = @segmentStats;
mySegmentStats = segmentanalysis(obj, 'ubssSum', channel, fnReference);
mySegmentStats


%% Example 5.1, calculate autocorrelation for each segment for a single stat
% This is simple, we make a new matlab function (in a .m file) following
%   the prototype of segmentStats() in segmentStats.m.
% In this function we (1) sort val along pDist and (2) use autocorr
%   function (Requires xxx toolbox)


%% Example 6, Plot tracing
% see: mmPlot.mapPlotTracing()

% look at first 5 rows in linedb table
obj.linedb{1}(1:5,:)

ps = mmMap.defaultPlotStruct();
ps.mapsegment = NaN; %0
ps.session = 1;
ps = obj.GetLine(ps);

plot(ps.line(:,1), ps.line(:,2), '.k', 'MarkerSize', 25);
xlabel('\mum');
ylabel('\mum');


%% Example 7, Display maximal intensity projection with annotations and tracing
% see: mmPlot.mapPlotImage()
ps = mmMap.defaultPlotStruct();
ps.session = 1;
ps.channel = 2;showAnnotations = 1;
showLines = 1;
plotMaxProject(obj,ps,showAnnotations, showLines);


%% Example 8, Plot a stat versus session using session condition
% see: mmPlot.mapPlotCondition()
%
%Each session in a map has a session condition
%obj.mapNV('condStr',:)
%mp = mmPlot(obj);
%h = mp.mapPlotCondition('ubssSum', 2, {'a1', 'b1', 'c2'});

% You can easily set session conditions yourself
%obj.mapNV('cond',[1 2 3 4]) = ['c1', 'c2','e1','e2']

%% Example 9, Find notes in a map
result1 = obj.find('note', 'Dim?');
result1(1:5,:) % view table of first 5 results
result2 = obj.find('note', '*');
result2(1:5,:) % view table of first 5 results

%% Example 10, Add new analysis to a map
ps = mmMap.defaultPlotStruct();
ps.stat = 'ubssSum'; %'ubssSum';
ps.channel  = 2;
ps = obj.GetMapValues(ps);
newStatName = 'myNewStat';
[m,n] = size(ps.y);
newStatValues = NaN(m,n);
newStatValues = ps.y .* mean(ps.y(~isnan(ps.y))); % ubssSum / mean(ubssSum);
obj = obj.addUserStat(newStatName, newStatValues);

% and then plot the new stat
myMapPlot = mmPlot(obj);
myMapPlot.mapPlot(NaN, newStatName, NaN);

##### SOURCE END #####
--></body></html>